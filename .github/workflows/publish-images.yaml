name: Publish Container Images

on:
  push:
    branches:
      - master
    tags:
      - 'controller-v*'
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish images to registry'
        required: true
        default: 'true'
        type: boolean

env:
  REGISTRY: docker.io/arybach
  PLATFORMS: linux/amd64,linux/arm64
  GOLANG_VERSION: '1.25.4'

jobs:
  build-nginx-base:
    name: Build NGINX Base Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      nginx-tag: ${{ steps.nginx-version.outputs.tag }}
      nginx-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get NGINX version
        id: nginx-version
        run: |
          # Extract version from images/nginx/TAG or use default
          if [ -f images/nginx/TAG ]; then
            TAG=$(cat images/nginx/TAG)
          else
            TAG=v2.2.5
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "NGINX version: ${TAG}"

      - name: Check if NGINX image exists
        id: check-nginx
        run: |
          TAG=${{ steps.nginx-version.outputs.tag }}
          if docker manifest inspect ${REGISTRY}/nginx:${TAG} >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "NGINX image ${TAG} already exists, skipping build"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "NGINX image ${TAG} does not exist, will build"
          fi

      - name: Build and push NGINX base image
        id: build
        if: steps.check-nginx.outputs.exists == 'false'
        uses: docker/build-push-action@v5
        with:
          context: ./images/nginx/rootfs
          platforms: ${{ env.PLATFORMS }}
          push: true
          build-args: |
            GOLANG_VERSION=${{ env.GOLANG_VERSION }}
          tags: |
            ${{ env.REGISTRY }}/nginx:${{ steps.nginx-version.outputs.tag }}
            ${{ env.REGISTRY }}/nginx:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: Update NGINX_BASE file
        if: steps.check-nginx.outputs.exists == 'false'
        run: |
          TAG=${{ steps.nginx-version.outputs.tag }}
          DIGEST=${{ steps.build.outputs.digest }}
          echo "${REGISTRY}/nginx:${TAG}@${DIGEST}" > NGINX_BASE
          echo "Updated NGINX_BASE to: $(cat NGINX_BASE)"

      - name: Upload NGINX_BASE artifact
        if: steps.check-nginx.outputs.exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: nginx-base-ref
          path: NGINX_BASE

  # build-controller:
  #   name: Build Controller Images
  #   runs-on: ubuntu-latest
  #   needs: build-nginx-base
  #   permissions:
  #     contents: read
  #     packages: write
  #   strategy:
  #     matrix:
  #       variant: [controller, controller-chroot]
  #   # Controller builds require compiling Go binaries first
  #   # This needs to be implemented separately with proper build steps
  #   # Disabled for now to focus on nginx base and support images
  #       steps:
  #         - name: Checkout code
  #           uses: actions/checkout@v4
  #   
  #         - name: Set up Docker Buildx
  #           uses: docker/setup-buildx-action@v3
  #   
  #         - name: Log in to Docker Hub
  #           uses: docker/login-action@v3
  #           with:
  #             username: ${{ secrets.DOCKERHUB_USERNAME }}
  #             password: ${{ secrets.DOCKERHUB_TOKEN }}
  #   
  #         - name: Get version
  #           id: version
  #           run: |
  #             if [ -f TAG ]; then
  #               VERSION=$(cat TAG)
  #             else
  #               VERSION=v1.14.0-redevops.1
  #             fi
  #             # For tagged releases, use the tag name
  #             if [[ "${{ github.ref }}" == refs/tags/controller-v* ]]; then
  #               VERSION=${GITHUB_REF#refs/tags/controller-}
  #             fi
  #             echo "version=${VERSION}" >> $GITHUB_OUTPUT
  #             echo "short-sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
  #             echo "Build version: ${VERSION}"
  #   
  #         - name: Download NGINX_BASE artifact
  #           uses: actions/download-artifact@v4
  #           with:
  #             name: nginx-base-ref
  #           continue-on-error: true
  #   
  #         - name: Get NGINX base image
  #           id: nginx-base
  #           run: |
  #             if [ -f NGINX_BASE ]; then
  #               BASE=$(cat NGINX_BASE)
  #             else
  #               BASE="${REGISTRY}/nginx:${{ needs.build-nginx-base.outputs.nginx-tag }}"
  #             fi
  #             echo "image=${BASE}" >> $GITHUB_OUTPUT
  #             echo "Using NGINX base: ${BASE}"
  #   
  #         - name: Determine Dockerfile
  #           id: dockerfile
  #           run: |
  #             if [ "${{ matrix.variant }}" = "controller-chroot" ]; then
  #               echo "file=rootfs/Dockerfile-chroot" >> $GITHUB_OUTPUT
  #             else
  #               echo "file=rootfs/Dockerfile" >> $GITHUB_OUTPUT
  #             fi
  #   
  #         - name: Build and push controller image
  #           uses: docker/build-push-action@v5
  #           with:
  #             context: .
  #             file: ${{ steps.dockerfile.outputs.file }}
  #             platforms: ${{ env.PLATFORMS }}
  #             push: true
  #             build-args: |
  #               BASE_IMAGE=${{ steps.nginx-base.outputs.image }}
  #               VERSION=${{ steps.version.outputs.version }}
  #             tags: |
  #               ${{ env.REGISTRY }}/${{ matrix.variant }}:${{ steps.version.outputs.version }}
  #               ${{ env.REGISTRY }}/${{ matrix.variant }}:latest
  #               ${{ env.REGISTRY }}/${{ matrix.variant }}:${{ steps.version.outputs.short-sha }}
  #             cache-from: type=gha
  #             cache-to: type=gha,mode=max
  #             labels: |
  #               org.opencontainers.image.source=${{ github.repositoryUrl }}
#               org.opencontainers.image.revision=${{ github.sha }}
#               org.opencontainers.image.version=${{ steps.version.outputs.version }}
#               org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

  build-support-images:
    name: Build Support Images
    runs-on: ubuntu-latest
    needs: build-nginx-base  # Ensure nginx base is built first for e2e-test-echo
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        image:
          - kube-webhook-certgen
          - custom-error-pages
          - e2e-test-echo
          - httpbun
          - ext-auth-example-authsvc
          - cfssl
          - fastcgi-helloserver
          - go-grpc-greeter-server
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get version
        id: version
        run: |
          # Check for image-specific TAG file
          if [ -f images/${{ matrix.image }}/TAG ]; then
            VERSION=$(cat images/${{ matrix.image }}/TAG)
          else
            VERSION=$(date +%Y%m%d)-$(git rev-parse --short HEAD)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Build ${{ matrix.image }} version: ${VERSION}"

      - name: Check if Dockerfile exists
        id: check-dockerfile
        run: |
          if [ -f images/${{ matrix.image }}/Dockerfile ]; then
            echo "dockerfile=images/${{ matrix.image }}/Dockerfile" >> $GITHUB_OUTPUT
            echo "context=images/${{ matrix.image }}" >> $GITHUB_OUTPUT
          elif [ -f images/${{ matrix.image }}/rootfs/Dockerfile ]; then
            echo "dockerfile=images/${{ matrix.image }}/rootfs/Dockerfile" >> $GITHUB_OUTPUT
            echo "context=images/${{ matrix.image }}/rootfs" >> $GITHUB_OUTPUT
          else
            echo "Error: No Dockerfile found for ${{ matrix.image }}"
            exit 1
          fi

      - name: Set build args for image
        id: build-args
        run: |
          # Only e2e-test-echo needs BASE_IMAGE and LUAROCKS
          if [ "${{ matrix.image }}" = "e2e-test-echo" ]; then
            cat >> $GITHUB_OUTPUT <<'EOF'
          args<<EOFARGS
          GOLANG_VERSION=${{ env.GOLANG_VERSION }}
          BASE_IMAGE=${{ env.REGISTRY }}/nginx:latest
          LUAROCKS_VERSION=v3.12.2
          LUAROCKS_SHA=9c25fa7ab5017d60b25137ab1a4cb76e3185df1fe02df1f577f57d1a6b548a2a
          EOFARGS
          EOF
          else
            cat >> $GITHUB_OUTPUT <<'EOF'
          args<<EOFARGS
          GOLANG_VERSION=${{ env.GOLANG_VERSION }}
          EOFARGS
          EOF
          fi

      - name: Build and push support image
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.check-dockerfile.outputs.context }}
          file: ${{ steps.check-dockerfile.outputs.dockerfile }}
          platforms: ${{ env.PLATFORMS }}
          push: true
          build-args: ${{ steps.build-args.outputs.args }}
          tags: |
            ${{ env.REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ matrix.image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.version.outputs.version }}

  # update-manifests:
  #   name: Update Deployment Manifests
  #   runs-on: ubuntu-latest
  #   needs: [build-support-images]  # Changed from build-controller
#  #   if: startsWith(github.ref, 'refs/tags/controller-v')
#  #   # Disabled until controller builds are implemented
#    permissions:
#      contents: write
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#
#      - name: Get version
#        id: version
#        run: |
#          VERSION=${GITHUB_REF#refs/tags/controller-}
#          echo "version=${VERSION}" >> $GITHUB_OUTPUT
#
#      - name: Update Helm chart
#        run: |
#          VERSION=${{ steps.version.outputs.version }}
#          # Update Chart.yaml
#          sed -i "s/^version:.*/version: ${VERSION}/" charts/ingress-nginx/Chart.yaml
#          sed -i "s/^appVersion:.*/appVersion: ${VERSION}/" charts/ingress-nginx/Chart.yaml
#          # Update values.yaml
#          sed -i "s|repository:.*controller|repository: ${REGISTRY}/controller|g" charts/ingress-nginx/values.yaml
#          sed -i "s/tag:.*/tag: ${VERSION}/" charts/ingress-nginx/values.yaml
#          echo "Updated Helm chart to version ${VERSION}"
#
#      - name: Update static manifests
#        run: |
#          VERSION=${{ steps.version.outputs.version }}
#          # Update deploy/static/provider/cloud/deploy.yaml
#          if [ -f deploy/static/provider/cloud/deploy.yaml ]; then
#            sed -i "s|image:.*controller.*|image: ${REGISTRY}/controller:${VERSION}|g" \
#              deploy/static/provider/cloud/deploy.yaml
#          fi
#          # Update other static manifests
#          find deploy/static/provider -name "*.yaml" -exec \
#            sed -i "s|image:.*controller.*|image: ${REGISTRY}/controller:${VERSION}|g" {} \;
#
#      - name: Create commit
#        run: |
#          git config user.name "github-actions[bot]"
#          git config user.email "github-actions[bot]@users.noreply.github.com"
#          git add charts/ deploy/
#          git commit -m "Update manifests for release ${{ steps.version.outputs.version }}" || echo "No changes to commit"
#          git push origin HEAD:master || echo "Nothing to push"
#
#  create-release:
#    name: Create GitHub Release
#    runs-on: ubuntu-latest
#    needs: [build-controller, build-support-images]
#    if: startsWith(github.ref, 'refs/tags/controller-v')
#    permissions:
#      contents: write
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Get version
#        id: version
#        run: |
#          VERSION=${GITHUB_REF#refs/tags/controller-}
#          echo "version=${VERSION}" >> $GITHUB_OUTPUT
#
#      - name: Generate release notes
#        id: notes
#        run: |
#          VERSION=${{ steps.version.outputs.version }}
#          cat > release-notes.md <<EOF
#          ## ingress-nginx ${VERSION}
#          ### Container Images
#          - **Controller**: \`${REGISTRY}/controller:${VERSION}\`
#          - **Controller (chroot)**: \`${REGISTRY}/controller-chroot:${VERSION}\`
#          - **NGINX Base**: \`${REGISTRY}/nginx:latest\`
#          ### Installation
#          \`\`\`bash
#          helm upgrade --install ingress-nginx charts/ingress-nginx \\
#            --namespace ingress-nginx --create-namespace \\
#            --set controller.image.repository=${REGISTRY}/controller \\
#            --set controller.image.tag=${VERSION}
#          \`\`\`
#          ### Support Images
#          - kube-webhook-certgen: \`${REGISTRY}/kube-webhook-certgen:latest\`
#          - custom-error-pages: \`${REGISTRY}/custom-error-pages:latest\`
#          - Additional test/example images available
#          ### Security Hardening (redevops fork)
#          This fork includes enhanced security:
#          - ✅ Mandatory path validation (CVE-2025-1974)
#          - ✅ Snippet annotations permanently disabled
#          - ✅ Cross-namespace resources blocked
#          - ✅ Auth URL quoting (CVE-2025-1097)
#          - ✅ Password file traversal prevention (CVE-2025-24513)
#          - ✅ Certificate MatchCN quoting (CVE-2025-24514)
#          ### Compatibility
#          - Kubernetes: 1.32, 1.33, 1.34
#          - NGINX: Based on custom build with OpenTelemetry, ModSecurity
#          ### Documentation
#          - [Installation Guide](https://github.com/redevops-io/ingress-nginx/blob/master/docs/deploy/index.md)
#          - [Independent Operation Guide](https://github.com/redevops-io/ingress-nginx/blob/master/docs/INDEPENDENT_OPERATION.md)
#          - [Security Policy](https://github.com/redevops-io/ingress-nginx/blob/master/SECURITY.md)
#          ---
#          **Full Changelog**: https://github.com/redevops-io/ingress-nginx/compare/v1.14.0...${VERSION}
#          EOF
#          echo "Generated release notes"
#
#      - name: Create GitHub Release
#        uses: softprops/action-gh-release@v1
#        with:
#          body_path: release-notes.md
#          draft: false
#          prerelease: false
#          generate_release_notes: true
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
#  verify-images:
#    name: Verify Published Images
#    runs-on: ubuntu-latest
#    needs: [build-controller, build-support-images]
#    steps:
#      - name: Get version
#        id: version
#        run: |
#          if [[ "${{ github.ref }}" == refs/tags/controller-v* ]]; then
#            VERSION=${GITHUB_REF#refs/tags/controller-}
#          elif [ -f TAG ]; then
#            VERSION=$(cat TAG)
#          else
#            VERSION=latest
#          fi
#          echo "version=${VERSION}" >> $GITHUB_OUTPUT
#
#      - name: Verify controller image
#        run: |
#          docker manifest inspect ${REGISTRY}/controller:${{ steps.version.outputs.version }}
#          docker manifest inspect ${REGISTRY}/controller-chroot:${{ steps.version.outputs.version }}
#          echo "✅ Controller images verified"
#
#      - name: Verify support images
#        run: |
#          for img in kube-webhook-certgen custom-error-pages; do
#            docker manifest inspect ${REGISTRY}/${img}:latest
#          done
#          echo "✅ Support images verified"
#
#      - name: Pull and inspect controller
#        run: |
#          docker pull ${REGISTRY}/controller:${{ steps.version.outputs.version }}
#          docker inspect ${REGISTRY}/controller:${{ steps.version.outputs.version }}
#          echo "✅ Controller image inspection complete"
