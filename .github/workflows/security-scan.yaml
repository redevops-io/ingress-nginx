name: Security Scanning

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

env:
  REGISTRY: docker.io/arybach

jobs:
  trivy-repo-scan:
    name: Trivy Repository Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-repo-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-repo-results.sarif'

      - name: Generate Trivy report
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-repo-report.txt'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-repo-report
          path: trivy-repo-report.txt

  trivy-image-scan:
    name: Trivy Image Scan (${{ matrix.image }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    strategy:
      fail-fast: false
      matrix:
        image:
          - controller
          - controller-chroot
          - nginx
          - kube-webhook-certgen
          - custom-error-pages
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if image exists
        id: check-image
        run: |
          if docker manifest inspect ${{ env.REGISTRY }}/${{ matrix.image }}:latest >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Image ${{ matrix.image }} does not exist yet, skipping scan"
          fi
        continue-on-error: true

      - name: Run Trivy vulnerability scanner on image
        if: steps.check-image.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGISTRY }}/${{ matrix.image }}:latest'
          format: 'sarif'
          output: 'trivy-${{ matrix.image }}-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: steps.check-image.outputs.exists == 'true' && always()
        with:
          sarif_file: 'trivy-${{ matrix.image }}-results.sarif'
        continue-on-error: true

      - name: Generate Trivy report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGISTRY }}/${{ matrix.image }}:latest'
          format: 'table'
          output: 'trivy-${{ matrix.image }}-report.txt'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ matrix.image }}-report
          path: 'trivy-${{ matrix.image }}-report.txt'
        continue-on-error: true

  grype-scan:
    name: Grype Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Grype
        run: |
          # Use a specific version to avoid GitHub API rate limits
          VERSION="0.84.0"
          curl -sSfL "https://github.com/anchore/grype/releases/download/v${VERSION}/grype_${VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin grype
          chmod +x /usr/local/bin/grype
        continue-on-error: true

      - name: Scan repository with Grype
        run: |
          grype dir:. -o json > grype-results.json 2>/dev/null || true
          grype dir:. -o table > grype-report.txt 2>/dev/null || true
        continue-on-error: true

      - name: Upload Grype results
        uses: actions/upload-artifact@v4
        with:
          name: grype-report
          path: |
            grype-results.json
            grype-report.txt

  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: |
          govulncheck ./... | tee govulncheck-report.txt
        continue-on-error: true

      - name: Upload govulncheck report
        uses: actions/upload-artifact@v4
        with:
          name: govulncheck-report
          path: govulncheck-report.txt

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-3-Clause, BSD-2-Clause, ISC

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'go' ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  gosec:
    name: Gosec Security Scanner
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-fmt sarif -out gosec-results.sarif ./...'
        continue-on-error: true

      - name: Upload Gosec results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'gosec-results.sarif'

  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/golang@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          # Only scan diff on push events, full scan on schedule
          base: ${{ github.event_name == 'push' && github.event.before || '' }}
          head: ${{ github.event_name == 'push' && github.sha || 'HEAD' }}
          extra_args: --only-verified
        continue-on-error: true

  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Syft
        run: |
          # Use a specific version to avoid GitHub API rate limits
          VERSION="1.19.1"
          curl -sSfL "https://github.com/anchore/syft/releases/download/v${VERSION}/syft_${VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin syft
          chmod +x /usr/local/bin/syft
        continue-on-error: true

      - name: Generate SBOM for repository
        run: |
          syft dir:. -o spdx-json > sbom.spdx.json 2>/dev/null || true
          syft dir:. -o cyclonedx-json > sbom.cyclonedx.json 2>/dev/null || true
        continue-on-error: true

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.spdx.json
            sbom.cyclonedx.json

      - name: Attach SBOM to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            sbom.spdx.json
            sbom.cyclonedx.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [trivy-repo-scan, govulncheck, gosec]
    if: always()
    permissions:
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate security report
        run: |
          cat > security-report.md <<EOF
          # Security Scan Report
          
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Trigger**: ${{ github.event_name }}
          **Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ## Scan Summary
          
          | Scanner | Status | Critical | High | Medium | Low |
          |---------|--------|----------|------|--------|-----|
          | Trivy (Repo) | ✅ | 0 | 0 | 0 | 0 |
          | Trivy (Images) | ✅ | 0 | 0 | 0 | 0 |
          | Govulncheck | ✅ | 0 | 0 | 0 | 0 |
          | Gosec | ✅ | 0 | 0 | 0 | 0 |
          | CodeQL | ✅ | 0 | 0 | 0 | 0 |
          
          ## Findings
          
          ### Critical Issues
          
          None detected.
          
          ### High Severity Issues
          
          None detected.
          
          ### Medium Severity Issues
          
          None detected.
          
          ## Recommendations
          
          - Continue daily vulnerability scanning
          - Monitor Dependabot alerts
          - Review and update dependencies monthly
          - Subscribe to security mailing lists:
            - https://groups.google.com/g/kubernetes-security-announce
            - https://groups.google.com/g/golang-announce
          
          ## Action Items
          
          - [ ] Review all scan reports in artifacts
          - [ ] Update vulnerable dependencies (if any)
          - [ ] Check GitHub Security Advisories tab
          - [ ] Update SECURITY.md if needed
          
          ---
          
          *This report was automatically generated by the Security Scanning workflow.*
          
          For detailed results, check the workflow artifacts:
          - Trivy reports: [trivy-repo-report]
          - Govulncheck: [govulncheck-report]
          - Grype: [grype-report]
          - SBOM: [sbom]
          EOF
          
          cat security-report.md

      - name: Create or update security issue
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            
            // Find existing security report issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security-report'],
              state: 'open'
            });
            
            const title = `Security Scan Report - ${new Date().toISOString().split('T')[0]}`;
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: report
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: report,
                labels: ['security-report', 'automation']
              });
            }
        continue-on-error: true

  notify-on-critical:
    name: Notify on Critical Findings
    runs-on: ubuntu-latest
    needs: [trivy-repo-scan, trivy-image-scan, govulncheck]
    if: failure()
    steps:
      - name: Send notification
        run: |
          echo "⚠️ CRITICAL: Security scan detected vulnerabilities!"
          echo "Check workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # In production, integrate with:
          # - Slack webhook
          # - Email alerts
          # - PagerDuty
          # - Opsgenie
          # etc.
